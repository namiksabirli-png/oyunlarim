<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Video GÃ¶rÃ¼ÅŸme & Ekran PaylaÅŸÄ±mÄ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .video-mirror { transform: scaleX(-1); }

        .video-box { transition: all 0.5s ease-in-out; }
        .video-container { transition: all 0.5s ease-in-out; }

        /* Ekran paylaÅŸÄ±mÄ± sÄ±rasÄ±nda kameralarÄ±n kÃ¼Ã§Ã¼lmesi iÃ§in */
        .minimized-layout {
            position: fixed;
            top: 20px;
            right: 20px;
            flex-direction: column;
            width: 220px;
            gap: 10px;
            z-index: 40;
        }

        .minimized-layout .video-box {
            width: 100% !important;
            border-width: 2px;
        }

        .minimized-layout .label {
            font-size: 0.6rem;
            padding: 2px 6px;
        }

        /* Ekran PaylaÅŸÄ±m Overlay (video YOK â€“ sonsuz gÃ¶rÃ¼ntÃ¼ sorunu bu sayede Ã§Ã¶zÃ¼lÃ¼yor) */
        #screenShareStage {
            display: none;
        }
    </style>
</head>

<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center p-4">

    <!-- Ekran paylaÅŸÄ±mÄ± sÄ±rasÄ±nda Ã¼stte gÃ¶zÃ¼ken uyarÄ± -->
    <div id="screenShareStage" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-30">
        <div class="bg-gray-900 bg-opacity-90 px-6 py-3 rounded-xl text-white font-bold text-sm sm:text-base animate-pulse">
            ðŸ’» EkranÄ±nÄ±z paylaÅŸÄ±lÄ±yor...
        </div>
    </div>

    <!-- ÃœST KONTROL PANELÄ° -->
    <div class="relative z-20 control-panel bg-gray-800 p-4 sm:p-6 rounded-xl shadow-2xl flex flex-col md:flex-row gap-4 items-center w-full max-w-5xl mb-6">
        <!-- KENDÄ° ID BÄ°LGÄ°SÄ° -->
        <div class="flex flex-col items-center md:items-start p-3 bg-gray-700 rounded-lg w-full md:w-auto">
            <span class="text-sm font-medium text-gray-400">Senin ID'n:</span>
            <div class="font-mono text-xl text-green-400 mt-1 select-all" id="myId">...</div>
        </div>

        <div class="h-1 bg-gray-700 w-full md:w-px md:h-12 md:mx-4"></div>

        <!-- BAÄžLANTI ALANI -->
        <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto md:flex-grow items-center">
            <input type="text" id="remoteIdInput" placeholder="KarÅŸÄ± ID"
                   class="p-2.5 rounded-lg border border-gray-600 bg-gray-700 text-white w-full sm:w-40">
            <input type="password" id="passwordInput" placeholder="Åžifre"
                   class="p-2.5 rounded-lg border border-gray-600 bg-gray-700 text-white w-full sm:w-28">

            <button onclick="connectToPeer()"
                    class="p-2.5 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg w-full sm:w-28">
                BaÄŸlan
            </button>

            <button onclick="toggleScreenShare()" id="shareBtn"
                    class="p-2.5 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg w-full sm:w-auto flex items-center justify-center gap-2">
                <span>ðŸ“º</span> <span id="shareBtnText">Ekran PaylaÅŸ</span>
            </button>

            <button onclick="endCall()"
                    class="p-2.5 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg w-full sm:w-auto">
                GÃ¶rÃ¼ÅŸmeyi Bitir
            </button>
        </div>
    </div>

    <div id="status" class="relative z-20 mb-4 text-sm text-gray-400">Durum: HazÄ±r</div>

    <!-- KAMERA GÃ–RÃœNTÃœLERÄ° -->
    <div id="cameraContainer" class="video-container relative z-10 flex flex-wrap justify-center gap-6 w-full max-w-6xl">
        <!-- SEN -->
        <div class="video-box relative w-full sm:w-5/12 max-w-md bg-black rounded-xl overflow-hidden shadow-2xl border-4 border-gray-700">
            <video id="localVideo" autoplay muted playsinline class="w-full h-full object-cover video-mirror"></video>
            <div class="label absolute bottom-3 left-3 bg-black bg-opacity-60 text-white px-3 py-1 text-xs rounded-md">
                Sen
            </div>
        </div>

        <!-- KARÅžI TARAF -->
        <div class="video-box relative w-full sm:w-5/12 max-w-md bg-black rounded-xl overflow-hidden shadow-2xl border-4 border-gray-700">
            <video id="remoteVideo" autoplay playsinline class="w-full h-full object-cover"></video>
            <div class="label absolute bottom-3 left-3 bg-black bg-opacity-60 text-white px-3 py-1 text-xs rounded-md">
                KarÅŸÄ± Taraf
            </div>
        </div>
    </div>

    <script>
        const EXPECTED_PASSWORD = "123";

        let peer = null;
        let localStream = null;
        let currentCall = null;
        let screenStream = null;
        let isSharing = false;
        let pendingCall = null;

        const myIdEl = document.getElementById('myId');
        const statusEl = document.getElementById('status');
        const remoteVideoEl = document.getElementById('remoteVideo');
        const localVideoEl = document.getElementById('localVideo');
        const remoteIdInput = document.getElementById('remoteIdInput');
        const passwordInput = document.getElementById('passwordInput');
        const cameraContainer = document.getElementById('cameraContainer');
        const screenStage = document.getElementById('screenShareStage');
        const shareBtnText = document.getElementById('shareBtnText');

        // 1. Kamera + mikrofonu baÅŸlat (ses ayarlarÄ± iyileÅŸtirilmiÅŸ)
        navigator.mediaDevices.getUserMedia({
            video: true,
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            }
        }).then(stream => {
            localStream = stream;
            localVideoEl.srcObject = stream;
            initPeer();
        }).catch(err => {
            statusEl.innerText = "Kamera HatasÄ±: " + err;
        });

        // 2. PeerJS baÅŸlat
        function initPeer() {
            peer = new Peer();

            peer.on('open', id => {
                myIdEl.innerText = id;
                statusEl.innerText = "ID hazÄ±r, baÄŸlantÄ± bekleniyor...";
            });

            // Gelen arama isteÄŸi
            peer.on('call', call => {
                const incomingPassword = call.metadata?.password;
                if (incomingPassword !== EXPECTED_PASSWORD) {
                    call.close();
                    return;
                }

                pendingCall = call;
                showRequestPopup();
            });
        }

        // 3. GÃ¶rÃ¼ÅŸme isteÄŸi popup
        function showRequestPopup() {
            const div = document.createElement("div");
            div.id = "reqPopup";
            div.className = "fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50";

            div.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-xl w-80 text-center">
                    <div class="text-lg mb-3">GÃ¶rÃ¼ÅŸme isteÄŸi geldi</div>
                    <button id="acceptBtn" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded w-full mb-2">
                        Kabul Et
                    </button>
                    <button id="rejectBtn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded w-full">
                        Reddet
                    </button>
                </div>
            `;
            document.body.appendChild(div);

            document.getElementById("acceptBtn").onclick = () => {
                document.getElementById("reqPopup").remove();
                if (pendingCall) {
                    pendingCall.answer(localStream);
                    handleCall(pendingCall);
                }
            };

            document.getElementById("rejectBtn").onclick = () => {
                document.getElementById("reqPopup").remove();
                if (pendingCall) {
                    pendingCall.close();
                    pendingCall = null;
                }
            };
        }

        // 4. KarÅŸÄ± tarafa baÄŸlan (istek gÃ¶nder)
        function connectToPeer() {
            const remoteId = remoteIdInput.value.trim();
            const password = passwordInput.value.trim();

            if (!remoteId) {
                alert("KarÅŸÄ± ID'yi yazmalÄ±sÄ±n.");
                return;
            }

            if (password !== EXPECTED_PASSWORD) {
                alert("HatalÄ± ÅŸifre!");
                return;
            }

            if (!localStream) {
                alert("Kamera izni gerekli!");
                return;
            }

            statusEl.innerText = "GÃ¶rÃ¼ÅŸme isteÄŸi gÃ¶nderiliyor...";

            const call = peer.call(remoteId, localStream, {
                metadata: { password: password }
            });

            handleCall(call);
        }

        // 5. Ortak gÃ¶rÃ¼ÅŸme yÃ¶netimi
        function handleCall(call) {
            currentCall = call;

            call.on('stream', remoteStream => {
                remoteVideoEl.srcObject = remoteStream;
                statusEl.innerText = "BaÄŸlantÄ± kuruldu!";
            });

            call.on('close', () => {
                statusEl.innerText = "GÃ¶rÃ¼ÅŸme kapandÄ±.";
                remoteVideoEl.srcObject = null;
                stopScreenShare();
            });

            call.on('error', err => {
                console.error("Arama hatasÄ±:", err);
                statusEl.innerText = "GÃ¶rÃ¼ÅŸme hatasÄ±: " + err;
            });
        }

        // 6. GÃ¶rÃ¼ÅŸmeyi bitir
        function endCall() {
            if (currentCall) {
                currentCall.close();
                currentCall = null;
            }
            remoteVideoEl.srcObject = null;
            statusEl.innerText = "GÃ¶rÃ¼ÅŸme sonlandÄ±rÄ±ldÄ±.";
            stopScreenShare();
        }

        // 7. Ekran PaylaÅŸÄ±mÄ±
        async function toggleScreenShare() {
            if (!currentCall) {
                alert("Ã–nce bir gÃ¶rÃ¼ÅŸme baÅŸlatmalÄ±sÄ±n!");
                return;
            }

            if (!isSharing) {
                try {
                    // Ses kapalÄ±; sadece gÃ¶rÃ¼ntÃ¼ paylaÅŸÄ±yoruz
                    screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: true,
                        audio: false
                    });

                    const videoTrack = screenStream.getVideoTracks()[0];
                    const sender = currentCall.peerConnection
                        .getSenders()
                        .find(s => s.track && s.track.kind === 'video');

                    if (sender && videoTrack) {
                        sender.replaceTrack(videoTrack);
                    }

                    // ArayÃ¼z: kameralarÄ± kÃ¼Ã§Ã¼lt, paylaÅŸÄ±m overlay gÃ¶ster
                    cameraContainer.classList.add('minimized-layout');
                    screenStage.style.display = 'flex';
                    shareBtnText.innerText = "PaylaÅŸÄ±mÄ± Durdur";

                    videoTrack.onended = () => {
                        stopScreenShare();
                    };

                    isSharing = true;

                } catch (err) {
                    console.log("Ekran paylaÅŸÄ±mÄ± iptal edildi:", err);
                }
            } else {
                stopScreenShare();
            }
        }

        function stopScreenShare() {
            if (!isSharing) return;

            if (screenStream) {
                screenStream.getTracks().forEach(t => t.stop());
                screenStream = null;
            }

            // KamerayÄ± geri gÃ¶nder
            if (currentCall && localStream) {
                const cameraTrack = localStream.getVideoTracks()[0];
                const sender = currentCall.peerConnection
                    .getSenders()
                    .find(s => s.track && s.track.kind === 'video');

                if (sender && cameraTrack) {
                    sender.replaceTrack(cameraTrack);
                }
            }

            // ArayÃ¼zÃ¼ eski haline getir
            cameraContainer.classList.remove('minimized-layout');
            screenStage.style.display = 'none';
            shareBtnText.innerText = "Ekran PaylaÅŸ";

            isSharing = false;
        }
    </script>
</body>
</html>
