<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Video GÃ¶rÃ¼ÅŸme & Ekran PaylaÅŸÄ±mÄ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .video-mirror { transform: scaleX(-1); }
        
        /* Animasyonlar iÃ§in geÃ§iÅŸ efektleri */
        .video-box { transition: all 0.5s ease-in-out; }
        .video-container { transition: all 0.5s ease-in-out; }

        /* MÄ°NÄ°MÄ°ZE MODU (Ekran paylaÅŸÄ±lÄ±nca devreye girer) */
        .minimized-layout {
            position: fixed;
            top: 20px;
            right: 20px;
            flex-direction: column;
            width: 200px;
            gap: 10px;
            z-index: 50; /* Ekran paylaÅŸÄ±mÄ±nÄ±n Ã¼stÃ¼nde durmasÄ± iÃ§in */
        }

        .minimized-layout .video-box {
            width: 100% !important; /* KÃ¼Ã§Ã¼k boyut */
            border-width: 2px;
        }

        .minimized-layout .label {
            font-size: 0.6rem;
            padding: 2px 6px;
        }

        /* Ekran PaylaÅŸÄ±m AlanÄ± */
        #screenShareStage {
            display: none; /* BaÅŸlangÄ±Ã§ta gizli */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #111827;
            z-index: 10;
            align-items: center;
            justify-content: center;
        }
        
        #screenVideo {
            max-width: 100%;
            max-height: 100%;
        }

        /* Ä°stek kabul modalÄ± */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: #1f2937;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        /* YENÄ°: Ekran paylaÅŸÄ±mÄ± izleyici dÃ¼zeni */
        .screen-viewer-layout {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 100%;
            gap: 10px;
        }

        .screen-viewer-layout .screen-container {
            width: 100%;
            height: 80vh;
            background: black;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .screen-viewer-layout .video-preview {
            width: 200px;
            height: 150px;
            position: absolute;
            bottom: 20px;
            right: 20px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid white;
            z-index: 20;
        }

        .screen-viewer-layout .video-preview .label {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 2px 6px;
            font-size: 0.7rem;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center p-4">

    <!-- Ekran PaylaÅŸÄ±m AlanÄ± (PaylaÅŸan iÃ§in) -->
    <div id="screenShareStage" class="flex">
        <video id="screenVideo" autoplay playsinline></video>
        <div class="absolute bottom-10 bg-black bg-opacity-70 px-4 py-2 rounded text-white font-bold animate-pulse">
            ðŸ’» EkranÄ±nÄ±z PaylaÅŸÄ±lÄ±yor
        </div>
    </div>

    <!-- Gelen Arama ModalÄ± -->
    <div id="incomingCallModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Gelen Arama</h2>
            <p id="callerId" class="mb-4"></p>
            <div class="flex gap-4 justify-center">
                <button id="acceptCallBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                    Kabul Et
                </button>
                <button id="rejectCallBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                    Reddet
                </button>
            </div>
        </div>
    </div>

    <!-- Kontrol Paneli -->
    <div class="relative z-50 control-panel bg-gray-800 p-4 sm:p-6 rounded-xl shadow-2xl flex flex-col md:flex-row gap-4 items-center w-full max-w-5xl mb-6">
        
        <div class="flex flex-col items-center md:items-start p-3 bg-gray-700 rounded-lg w-full md:w-auto">
            <span class="text-sm font-medium text-gray-400">Senin ID'n:</span>
            <div class="font-mono text-xl text-green-400 mt-1 select-all" id="myId">...</div>
        </div>
        
        <div class="h-1 bg-gray-700 w-full md:w-px md:h-12 md:mx-4"></div>

        <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto md:flex-grow items-center">
            <input type="text" id="remoteIdInput" placeholder="KarÅŸÄ± ID" class="p-2.5 rounded-lg border border-gray-600 bg-gray-700 text-white w-full sm:w-32">
            <input type="password" id="passwordInput" placeholder="Åžifre" class="p-2.5 rounded-lg border border-gray-600 bg-gray-700 text-white w-full sm:w-24">
            <button onclick="requestConnection()" class="p-2.5 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg w-full sm:w-24">Ara</button>
            
            <button onclick="toggleScreenShare()" id="shareBtn" class="p-2.5 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg w-full sm:w-auto flex items-center justify-center gap-2">
                <span>ðŸ“º</span> <span id="shareBtnText">Ekran PaylaÅŸ</span>
            </button>
            
            <button onclick="endCall()" id="endCallBtn" class="p-2.5 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg w-full sm:w-auto flex items-center justify-center gap-2">
                <span>ðŸ“ž</span> <span>GÃ¶rÃ¼ÅŸmeyi Bitir</span>
            </button>
        </div>
    </div>

    <div id="status" class="relative z-50 mb-4 text-sm text-gray-400">Durum: HazÄ±r</div>

    <!-- Video Konteyneri - Normal ve Ekran Ä°zleme ModlarÄ± -->
    <div id="cameraContainer" class="video-container relative z-50 flex flex-wrap justify-center gap-6 w-full max-w-6xl">
        
        <div class="video-box relative w-full sm:w-5/12 max-w-md bg-black rounded-xl overflow-hidden shadow-2xl border-4 border-gray-700">
            <video id="localVideo" autoplay muted class="w-full h-full object-cover video-mirror"></video>
            <div class="label absolute bottom-3 left-3 bg-black bg-opacity-60 text-white px-3 py-1 text-xs rounded-md">Sen</div>
        </div>
        
        <div class="video-box relative w-full sm:w-5/12 max-w-md bg-black rounded-xl overflow-hidden shadow-2xl border-4 border-gray-700">
            <video id="remoteVideo" autoplay class="w-full h-full object-cover"></video>
            <div class="label absolute bottom-3 left-3 bg-black bg-opacity-60 text-white px-3 py-1 text-xs rounded-md">KarÅŸÄ± Taraf</div>
        </div>
    </div>

    <!-- Ekran Ä°zleme Konteyneri (Gizli) -->
    <div id="screenViewerContainer" class="screen-viewer-layout hidden w-full max-w-6xl">
        <div class="screen-container">
            <video id="screenViewerVideo" autoplay class="w-full h-full object-contain"></video>
            <div class="video-preview">
                <video id="localPreviewVideo" autoplay muted class="w-full h-full object-cover video-mirror"></video>
                <div class="label">Sen</div>
            </div>
            <div class="absolute top-3 left-3 bg-black bg-opacity-60 text-white px-3 py-1 text-sm rounded-md">
                ðŸ’» Ekran PaylaÅŸÄ±mÄ±
            </div>
        </div>
    </div>

    <script>
        const EXPECTED_PASSWORD = "123"; 
        
        let peer = null;
        let localStream = null;
        let currentCall = null;
        let screenStream = null;
        let isSharing = false;
        let incomingCall = null;
        let isReceivingScreenShare = false;

        const myIdEl = document.getElementById('myId');
        const statusEl = document.getElementById('status');
        const remoteVideoEl = document.getElementById('remoteVideo');
        const localVideoEl = document.getElementById('localVideo');
        const cameraContainer = document.getElementById('cameraContainer');
        const screenStage = document.getElementById('screenShareStage');
        const screenVideo = document.getElementById('screenVideo');
        const shareBtnText = document.getElementById('shareBtnText');
        const incomingCallModal = document.getElementById('incomingCallModal');
        const callerIdEl = document.getElementById('callerId');
        const acceptCallBtn = document.getElementById('acceptCallBtn');
        const rejectCallBtn = document.getElementById('rejectCallBtn');
        const endCallBtn = document.getElementById('endCallBtn');
        const screenViewerContainer = document.getElementById('screenViewerContainer');
        const screenViewerVideo = document.getElementById('screenViewerVideo');
        const localPreviewVideo = document.getElementById('localPreviewVideo');

        // 1. KamerayÄ± BaÅŸlat - Ses ayarlarÄ±nÄ± iyileÅŸtirdik
        navigator.mediaDevices.getUserMedia({ 
            video: true, 
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true,
                sampleRate: 48000,
                channelCount: 1,
                volume: 1.0
            }
        })
        .then(stream => {
            localStream = stream;
            localVideoEl.srcObject = stream;
            localPreviewVideo.srcObject = stream;
            initPeer();
        })
        .catch(err => {
            statusEl.innerText = "Kamera HatasÄ±: " + err;
        });

        // 2. PeerJS BaÅŸlat
        function initPeer() {
            peer = new Peer({
                config: {
                    'iceServers': [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                }
            });
            
            peer.on('open', id => {
                myIdEl.innerText = id;
                statusEl.innerText = "ID HazÄ±r, arama bekleniyor...";
            });

            peer.on('call', call => {
                const incomingPassword = call.metadata?.password;
                if (incomingPassword === EXPECTED_PASSWORD) {
                    incomingCall = call;
                    callerIdEl.innerText = `Arayan: ${call.peer}`;
                    incomingCallModal.style.display = 'flex';
                    statusEl.innerText = "Gelen arama bekleniyor...";
                } else {
                    call.close();
                    statusEl.innerText = "HatalÄ± ÅŸifre ile gelen arama reddedildi";
                }
            });
            
            peer.on('error', err => {
                console.error('PeerJS HatasÄ±:', err);
                statusEl.innerText = "BaÄŸlantÄ± hatasÄ±: " + err.type;
            });
        }

        // 3. Arama Ä°steÄŸi GÃ¶nder
        function requestConnection() {
            const remoteId = document.getElementById('remoteIdInput').value;
            const password = document.getElementById('passwordInput').value;
            
            if (password !== EXPECTED_PASSWORD) return alert("HatalÄ± Åžifre!");
            if (!localStream) return alert("Kamera izni gerekli!");

            statusEl.innerText = "AranÄ±yor...";
            const call = peer.call(remoteId, localStream, { metadata: { password: password } });
            handleCall(call);
        }

        // Gelen aramayÄ± kabul et
        acceptCallBtn.addEventListener('click', () => {
            if (incomingCall) {
                incomingCall.answer(localStream);
                handleCall(incomingCall);
                incomingCallModal.style.display = 'none';
                incomingCall = null;
            }
        });

        // Gelen aramayÄ± reddet
        rejectCallBtn.addEventListener('click', () => {
            if (incomingCall) {
                incomingCall.close();
                incomingCallModal.style.display = 'none';
                incomingCall = null;
                statusEl.innerText = "Arama reddedildi";
            }
        });

        // Ortak Arama YÃ¶netimi
        function handleCall(call) {
            currentCall = call;
            
            // Ses ayarlarÄ±nÄ± optimize et
            if (remoteVideoEl) {
                remoteVideoEl.volume = 1.0; // Maksimum ses seviyesi
            }
            
            call.on('stream', remoteStream => {
                statusEl.innerText = "BaÄŸlantÄ± Kuruldu!";
                remoteVideoEl.srcObject = remoteStream;
                
                // Ses kalitesini iyileÅŸtirmek iÃ§in ek ayarlar
                const audioTracks = remoteStream.getAudioTracks();
                if (audioTracks.length > 0) {
                    // Ses izleme iÃ§in olay dinleyicileri
                    audioTracks[0].enabled = true;
                }
            });
            
            // YENÄ°: Ekran paylaÅŸÄ±mÄ± tespiti iÃ§in data kanalÄ±
            call.on('connection', dataConnection => {
                dataConnection.on('data', data => {
                    if (data.type === 'screenShareStarted') {
                        // Ekran paylaÅŸÄ±mÄ± baÅŸladÄ± - gÃ¶rÃ¼ntÃ¼ dÃ¼zenini deÄŸiÅŸtir
                        switchToScreenViewerMode();
                    } else if (data.type === 'screenShareEnded') {
                        // Ekran paylaÅŸÄ±mÄ± bitti - normal moda dÃ¶n
                        switchToNormalMode();
                    }
                });
            });
            
            call.on('close', () => {
                statusEl.innerText = "GÃ¶rÃ¼ÅŸme sonlandÄ±.";
                remoteVideoEl.srcObject = null;
                switchToNormalMode(); // GÃ¶rÃ¼ÅŸme biterse normal moda dÃ¶n
                stopScreenShare(); // GÃ¶rÃ¼ÅŸme biterse paylaÅŸÄ±mÄ± da kapat
            });
            
            call.on('error', err => {
                console.error('Ã‡aÄŸrÄ± hatasÄ±:', err);
                statusEl.innerText = "Ã‡aÄŸrÄ± hatasÄ±: " + err.message;
            });
        }

        // GÃ¶rÃ¼ÅŸmeyi bitir
        function endCall() {
            if (currentCall) {
                currentCall.close();
                currentCall = null;
                remoteVideoEl.srcObject = null;
                switchToNormalMode(); // GÃ¶rÃ¼ÅŸme biterse normal moda dÃ¶n
                statusEl.innerText = "GÃ¶rÃ¼ÅŸme sonlandÄ±rÄ±ldÄ±";
            }
        }

        // YENÄ°: Ekran izleme moduna geÃ§iÅŸ
        function switchToScreenViewerMode() {
            cameraContainer.classList.add('hidden');
            screenViewerContainer.classList.remove('hidden');
            isReceivingScreenShare = true;
            statusEl.innerText = "Ekran paylaÅŸÄ±mÄ± izleniyor...";
        }

        // YENÄ°: Normal moda dÃ¶nÃ¼ÅŸ
        function switchToNormalMode() {
            cameraContainer.classList.remove('hidden');
            screenViewerContainer.classList.add('hidden');
            isReceivingScreenShare = false;
            statusEl.innerText = "BaÄŸlantÄ± kuruldu";
        }

        // --- EKRAN PAYLAÅžIMI ---
        async function toggleScreenShare() {
            if (!currentCall) {
                alert("Ã–nce bir gÃ¶rÃ¼ÅŸme baÅŸlatmalÄ±sÄ±nÄ±z!");
                return;
            }

            if (!isSharing) {
                // PaylaÅŸÄ±mÄ± BaÅŸlat
                try {
                    screenStream = await navigator.mediaDevices.getDisplayMedia({ 
                        video: { cursor: "always" }, 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            sampleRate: 48000
                        } 
                    });
                    
                    // 1. ArayÃ¼zÃ¼ DeÄŸiÅŸtir (Minimize Et)
                    cameraContainer.classList.remove('justify-center');
                    cameraContainer.classList.add('minimized-layout');
                    screenStage.style.display = 'flex';
                    screenVideo.srcObject = screenStream;
                    shareBtnText.innerText = "PaylaÅŸÄ±mÄ± Durdur";
                    
                    // 2. KarÅŸÄ± Tarafa Giden GÃ¶rÃ¼ntÃ¼yÃ¼ DeÄŸiÅŸtir (Track Replacement)
                    const videoTrack = screenStream.getVideoTracks()[0];
                    const audioTrack = screenStream.getAudioTracks()[0];
                    
                    // Video track'ini deÄŸiÅŸtir
                    const videoSender = currentCall.peerConnection.getSenders().find(s => 
                        s.track && s.track.kind === 'video'
                    );
                    if (videoSender) {
                        await videoSender.replaceTrack(videoTrack);
                    }
                    
                    // Ekran paylaÅŸÄ±mÄ± sesi varsa, ses track'ini de deÄŸiÅŸtir
                    if (audioTrack) {
                        const audioSender = currentCall.peerConnection.getSenders().find(s => 
                            s.track && s.track.kind === 'audio'
                        );
                        if (audioSender) {
                            await audioSender.replaceTrack(audioTrack);
                        }
                    }

                    // YENÄ°: KarÅŸÄ± tarafa ekran paylaÅŸÄ±mÄ± baÅŸladÄ±ÄŸÄ±nÄ± bildir
                    try {
                        const dataConnection = peer.connect(currentCall.peer);
                        dataConnection.on('open', () => {
                            dataConnection.send({ type: 'screenShareStarted' });
                        });
                    } catch (err) {
                        console.error("Data kanalÄ± hatasÄ±:", err);
                    }

                    // KullanÄ±cÄ± tarayÄ±cÄ± arayÃ¼zÃ¼nden "PaylaÅŸÄ±mÄ± Durdur" derse
                    videoTrack.onended = () => {
                        stopScreenShare(); 
                    };

                    isSharing = true;

                } catch (err) {
                    console.error("Ekran paylaÅŸÄ±mÄ± iptal edildi:", err);
                }
            } else {
                stopScreenShare();
            }
        }

        function stopScreenShare() {
            if (!isSharing) return;

            // 1. Ekran paylaÅŸÄ±mÄ±nÄ± kapat
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }

            // 2. ArayÃ¼zÃ¼ Eski Haline Getir
            screenStage.style.display = 'none';
            cameraContainer.classList.remove('minimized-layout');
            cameraContainer.classList.add('justify-center');
            shareBtnText.innerText = "Ekran PaylaÅŸ";

            // 3. KarÅŸÄ± Tarafa Tekrar KamerayÄ± GÃ¶nder
            if (currentCall && localStream) {
                const cameraVideoTrack = localStream.getVideoTracks()[0];
                const cameraAudioTrack = localStream.getAudioTracks()[0];
                
                const videoSender = currentCall.peerConnection.getSenders().find(s => 
                    s.track && s.track.kind === 'video'
                );
                if (videoSender && cameraVideoTrack) {
                    videoSender.replaceTrack(cameraVideoTrack);
                }
                
                const audioSender = currentCall.peerConnection.getSenders().find(s => 
                    s.track && s.track.kind === 'audio'
                );
                if (audioSender && cameraAudioTrack) {
                    audioSender.replaceTrack(cameraAudioTrack);
                }
                
                // YENÄ°: KarÅŸÄ± tarafa ekran paylaÅŸÄ±mÄ±nÄ±n bittiÄŸini bildir
                try {
                    const dataConnection = peer.connect(currentCall.peer);
                    dataConnection.on('open', () => {
                        dataConnection.send({ type: 'screenShareEnded' });
                    });
                } catch (err) {
                    console.error("Data kanalÄ± hatasÄ±:", err);
                }
            }

            isSharing = false;
        }
    </script>
</body>
</html>